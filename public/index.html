<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dutch ‚Ä¢ Royal Casino</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. VARIABLES & THEME --- */
        :root {
            /* Palette Casino */
            --felt-bg: #2d5a45;
            --felt-dark: #1b382b;
            --gold-primary: #d4af37;
            --gold-shine: #f7ef8a;
            --card-white: #fdfdfd;
            --card-red: #d93838;
            --card-black: #222;
            --glass-panel: rgba(20, 30, 25, 0.75);
            --glass-border: rgba(212, 175, 55, 0.3);
            
            /* Dimensions */
            --card-w: 85px;
            --card-h: 120px;
            --radius-card: 8px;
            --radius-ui: 16px;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            color: #eee;
            
            /* Texture Tapis de Jeu */
            background-color: var(--felt-bg);
            background-image: 
                radial-gradient(circle at center, transparent 0%, #000 120%),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- 2. ANIMATIONS --- */
        @keyframes deal {
            0% { transform: translateY(-50px) scale(0.8); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        @keyframes shine {
            0% { background-position: -100% 50%; }
            100% { background-position: 200% 50%; }
        }

        /* --- 3. UI COMPONENTS (GLASSMORPHISM) --- */
        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-ui);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Boutons Style "Jeton" ou "Lingot" */
        button {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            border: none;
            border-radius: 50px;
            padding: 12px 28px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        
        button:active { transform: scale(0.96); }

        .btn-primary { 
            background: linear-gradient(135deg, #d4af37, #aa8926); 
            color: #1a1a1a; 
            border: 1px solid #ffeebb;
        }
        .btn-primary:hover { box-shadow: 0 0 15px var(--gold-primary); filter: brightness(1.1); }

        .btn-dutch { 
            background: linear-gradient(135deg, #e74c3c, #c0392b); 
            color: white; 
            font-size: 1.1em;
            border: 1px solid #ff7b7b;
            animation: pulse-gold 2s infinite;
        }
        
        .btn-confirm { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .btn-cancel { background: rgba(255,255,255,0.1); color: #ddd; border: 1px solid rgba(255,255,255,0.3); }
        .btn-cancel:hover { background: rgba(255,255,255,0.2); color: white; }

        /* --- 4. LOGIN SCREEN --- */
        #login {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000;
            background: radial-gradient(circle, #2d5a45 0%, #000 100%);
        }
        #login.active { display: flex; }
        
        .login-card {
            padding: 50px 40px; 
            width: 90%; max-width: 420px; 
            text-align: center;
            border: 1px solid var(--gold-primary);
        }
        .login-card h1 {
            font-family: 'Cinzel', serif; font-size: 3.5em; color: var(--gold-primary);
            margin: 0 0 10px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            background: linear-gradient(to right, #bf953f, #fcf6ba, #bf953f);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { font-style: italic; opacity: 0.7; margin-bottom: 30px; font-family: 'Playfair Display', serif; }

        .login-input {
            width: 100%; padding: 16px; margin-bottom: 15px;
            border-radius: 8px; border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.3); color: var(--gold-primary);
            font-size: 1.1em; text-align: center; font-family: 'Cinzel', serif;
            transition: 0.3s;
        }
        .login-input:focus { outline: none; border-color: var(--gold-primary); background: rgba(0,0,0,0.5); }
        .login-input::placeholder { color: rgba(255,255,255,0.3); font-family: 'Roboto', sans-serif; }

        /* --- 5. GAME LAYOUT --- */
        #game-ui {
            display: none; height: 100vh; flex-direction: column;
            justify-content: space-between; padding: 10px;
            position: relative;
        }
        #game-ui.active { display: flex; }

        /* Opponents */
        #opponents-container {
            display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;
            padding-top: 15px; min-height: 140px;
        }
        
        .player-area {
            position: relative; padding: 10px 15px; border-radius: 12px;
            background: rgba(0,0,0,0.3); border: 1px solid transparent;
            transition: all 0.3s; text-align: center;
        }
        .player-area strong { 
            display: block; font-size: 0.85em; margin-bottom: 6px; 
            color: #aaa; font-family: 'Cinzel', serif; letter-spacing: 1px;
        }
        
        /* Active Turn Highlight */
        .player-area.active-turn {
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid var(--gold-primary);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }
        .player-area.active-turn strong { color: var(--gold-primary); text-shadow: 0 0 5px var(--gold-primary); }

        /* Table Center */
        .table-center {
            flex: 1; display: flex; justify-content: center; align-items: center; gap: 40px;
            position: relative;
        }
        
        /* Zones de Pioche/D√©fausse avec placeholders visuels */
        .pile-zone {
            position: relative; width: var(--card-w); height: var(--card-h);
            border-radius: var(--radius-card);
            border: 2px dashed rgba(255,255,255,0.1);
            display: flex; justify-content: center; align-items: center;
        }
.pile-zone::after {
            content: attr(data-label);
            position: absolute; 
            color: rgba(255,255,255,0.15);
            font-weight: bold; font-size: 0.8em; letter-spacing: 2px;
            
            /* --- LA CORRECTION --- */
            pointer-events: none; /* La souris traverse le texte */
            z-index: 0;           /* On s'assure que le texte reste au fond */
        }

        .pile { position: absolute; top: 0; left: 0; cursor: pointer; transition: transform 0.2s; }
        .pile:hover { transform: translateY(-5px); }

        /* Actions Bar */
        .actions-bar {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; align-items: center; justify-content: center;
            padding: 15px 30px; z-index: 500; min-width: 320px;
        }

/* My Area - DESIGN REVISIT√â */
        #my-player-area {
            align-self: center; 
            margin-bottom: 170px; 
            padding: 20px 40px;
            
            /* √âtat par d√©faut (Pas mon tour) : Style "Dark Glass" */
            background: rgba(10, 20, 15, 0.6); /* Tr√®s sombre et transparent */
            backdrop-filter: blur(8px);        /* Effet de flou derri√®re */
            -webkit-backdrop-filter: blur(8px);
            
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px; /* Bords plus arrondis */
            
            width: 95%; max-width: 650px;
            position: relative; 
            z-index: 10;
            
            /* Transition fluide pour l'effet d'allumage */
            transition: all 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Quand c'est MON TOUR : Lumi√®re et Or */
        #my-player-area.active-turn {
            background: linear-gradient(to top, rgba(212, 175, 55, 0.15), rgba(0,0,0,0.4));
            border-bottom: 2px solid var(--gold-primary);
            border-top: 1px solid var(--gold-primary);
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.15);
            transform: scale(1.02); /* L√©g√®re mise en avant */
        }

        /* Effet sur les cartes dans ma main */
        #my-player-area .card {
            transition: all 0.4s ease;
            filter: brightness(0.7) grayscale(0.2); /* Un peu sombre par d√©faut */
            transform: translateY(0);
        }

        /* Quand c'est MON TOUR, les cartes s'√©clairent */
        #my-player-area.active-turn .card {
            filter: brightness(1) grayscale(0); /* Pleine lumi√®re */
            cursor: pointer;
        }

        /* Hover sur les cartes (seulement si c'est mon tour ou m√©morisation) */
        #my-player-area.active-turn .card:hover, 
        #my-player-area .card.reveal-mode { 
            transform: translateY(-15px) scale(1.05); 
            filter: brightness(1.1);
        }

        #my-player-area h3 {
            margin: 0; 
            font-family: 'Cinzel', serif; 
            color: rgba(255,255,255,0.4); /* Gris par d√©faut */
            transition: color 0.3s;
            letter-spacing: 2px;
        }

        #my-player-area.active-turn h3 {
            color: var(--gold-primary); /* Dor√© quand c'est le tour */
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        /* --- 6. CARD DESIGN --- */
        .hand {
            display: flex; justify-content: center; gap: 12px; margin: 0 auto;
            perspective: 1000px;
        }
        
        .card {
            width: var(--card-w); height: var(--card-h);
            border-radius: var(--radius-card);
            background-color: var(--card-white);
            position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.5);
            cursor: pointer;
            font-family: 'Playfair Display', serif;
            font-weight: bold;
            font-size: 1.8em; line-height: 1;
            transition: transform 0.2s, box-shadow 0.2s, top 0.2s;
            animation: deal 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        
        /* Texture papier subtile */
        .card:not(.back)::before {
            content: ""; position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.5; pointer-events: none; border-radius: var(--radius-card);
        }

        .card:hover { 
            transform: translateY(-12px) scale(1.05); 
            z-index: 10; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.4); 
        }

        .card.red { color: var(--card-red); }
        .card.black { color: var(--card-black); }
        
        /* Coins (Suits) */
        .card .corner-suit {
            position: absolute; font-size: 0.4em; opacity: 1; font-family: 'Roboto', sans-serif;
            display: flex; flex-direction: column; align-items: center; line-height: 0.9;
        }
        .card .top-left { top: 6px; left: 6px; }
        .card .bottom-right { bottom: 6px; right: 6px; transform: rotate(180deg); }

        /* Design Dos de Carte (G√©om√©trique) */
        .card.back {
            background-color: #3e5f8a;
            background-image: 
                radial-gradient(white 15%, transparent 16%),
                radial-gradient(white 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            border: 4px solid white;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        /* Motif central du dos pour faire plus classe */
        .card.back::after {
            content: "‚ô¶";
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 2em; color: rgba(255,255,255,0.2);
        }
        .card.back div, .card.back span { display: none; }

        /* Highlight effects */
        .card.reveal-mode {
            border: 2px solid var(--gold-primary);
            box-shadow: 0 0 25px var(--gold-primary);
            animation: pulse-gold 1s infinite;
        }

        /* --- 7. LOGS & NOTIFICATIONS --- */
        #message-log {
            position: fixed; top: 20px; right: 20px; width: 320px;
            display: flex; flex-direction: column; align-items: flex-end;
            pointer-events: none; z-index: 1000;
        }
        .log-entry {
            background: rgba(20, 20, 20, 0.85); 
            color: #fff;
            padding: 10px 15px; margin-bottom: 8px; border-radius: 8px;
            font-size: 0.9em; border-left: 4px solid var(--gold-primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            animation: deal 0.3s forwards;
            backdrop-filter: blur(4px);
            font-family: 'Roboto', sans-serif;
        }

        /* --- 8. RULES MODAL --- */
        #rules-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .rules-content {
            background: #fff; color: #222; padding: 40px; border-radius: 12px;
            max-width: 550px; max-height: 85vh; overflow-y: auto; text-align: left;
            border: 4px solid var(--gold-primary);
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .rules-content h2 { margin-top: 0; color: #8b0000; font-family: 'Cinzel', serif; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .rules-content ul { line-height: 1.6; }
        .rules-content strong { color: #8b0000; }

        /* Responsive */
        @media (max-width: 600px) {
            :root { --card-w: 55px; --card-h: 80px; }
            .table-center { gap: 15px; }
            .player-area { padding: 5px; margin: 2px; }
            .pile-zone { border-width: 1px; }
            .pile-zone::after { font-size: 0.6em; }
            .login-card h1 { font-size: 2.5em; }
        }
    </style>
</head>
<body>

    <div id="login" class="active">
        <div class="glass-panel login-card">
            <h1>‚ô¶ DUTCH ‚ô¶</h1>
            <div class="subtitle">La m√©moire est votre seule arme.</div>
            
            <input type="text" id="username" class="login-input" placeholder="Votre Pseudo" autocomplete="off">
            <input type="text" id="room" class="login-input" placeholder="Salle (ex: Table 1)" value="Table1">
            
            <button class="btn-primary" onclick="joinGame()" style="width:100%; margin-top:10px;">
                Entrer dans le Casino
            </button>
            
            <div id="lobby-info" style="margin-top:25px; min-height:20px; color:var(--gold-primary); font-family:'Cinzel', serif;"></div>
            
            <button onclick="document.getElementById('rules-modal').style.display='flex'" style="margin-top:20px; background:none; border:none; color:rgba(255,255,255,0.5); font-size:0.8em; text-decoration:underline; box-shadow:none;">
                Lire les r√®gles du jeu
            </button>
        </div>
    </div>

        <div id="game-ui">
        <button onclick="leaveGame()" style="position:absolute; top:10px; left:10px; background:#f44336; color:white; font-size:0.8em; padding:5px 10px; z-index:1000;">
            üö™ Quitter
        </button>

        <div id="opponents-container"></div>

        <div class="table-center">
            
            <div class="pile-zone" data-label="PIOCHE">
                <div class="pile" onclick="drawCard('deck')">
                    <div class="card back"></div>
                </div>
            </div>
            
            <div class="pile-zone" data-label="D√âFAUSSE">
                <div class="pile" onclick="drawCard('discard')">
                    <div id="discard-pile-card" class="card" style="opacity:0; pointer-events:none;"></div>
                </div>
            </div>

            <div id="drawn-card-area" style="display:none; flex-direction:column; align-items:center; margin-left:20px;">
                <div id="drawn-card-display" class="card" style="box-shadow: 0 0 25px var(--gold-primary);"></div>
                <div style="margin-top:15px;">
                    <button class="btn-cancel" onclick="playAction('discard')">üóëÔ∏è Jeter</button>
                </div>
            </div>
        </div>

        <div id="my-player-area" class="player-area">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-family:'Cinzel', serif; color:#fff;">MOI</h3>
                <span id="my-score" style="font-weight:bold; color:var(--gold-primary); font-size:1.2em;"></span>
            </div>
            <div id="my-hand" class="hand"></div>
        </div>

        <div class="actions-bar glass-panel" id="actions-bar"></div>
    </div>

    <div id="message-log"></div>

    <div id="rules-modal" onclick="this.style.display='none'">
        <div class="rules-content" onclick="event.stopPropagation()">
            <h2>R√®gles Officielles</h2>
            <p><strong>Objectif :</strong> Terminer la manche avec le score le plus bas.</p>
            <ul>
                <li><strong>D√©but :</strong> M√©morisez 2 de vos 4 cartes face cach√©e.</li>
                <li><strong>Tour de jeu :</strong> 
                    <ul>
                        <li>Piochez une carte (du paquet ou de la d√©fausse).</li>
                        <li>√âchangez-la avec l'une de vos cartes (face cach√©e).</li>
                        <li>Ou jetez-la (si elle vient du paquet).</li>
                    </ul>
                </li>
                <li><strong>Pouvoirs (si carte jet√©e) :</strong>
                    <ul>
                        <li><strong>Valet (J) :</strong> √âchangez une de vos cartes avec un adversaire (√† l'aveugle).</li>
                        <li><strong>Dame (Q) :</strong> Regardez secr√®tement une de vos cartes.</li>
                    </ul>
                </li>
                <li><strong>Snap (√Ä la vol√©e) :</strong> Si une carte jou√©e est identique √† une de vos cartes, jetez la v√¥tre rapidement !</li>
                <li><strong>DUTCH :</strong> Si vous pensez avoir le meilleur score, annoncez "DUTCH". Un dernier tour commence.</li>
            </ul>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn-primary" onclick="document.getElementById('rules-modal').style.display='none'">J'ai compris</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- LOGIQUE CLIENT INCHANG√âE (Design Only) ---
        const socket = io();
        let myId = null;
        let gameState = null;
        
        let memoryLocked = false; 
        let tempRevealedIndex = null; 
        let tempRevealedCardData = null; 

        function showScreen(id) {
            document.querySelectorAll('body > div[id]').forEach(d => d.classList.remove('active'));
            const el = document.getElementById(id);
            if(el) el.classList.add('active');
        }
        
        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry'; 
            div.innerHTML = msg; 
            document.getElementById('message-log').appendChild(div);
            // Suppression auto
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateX(20px)';
                div.style.transition = 'all 0.5s';
                setTimeout(() => div.remove(), 500);
            }, 4000);
        }

        // --- CONNECTION ---
        function joinGame() {
            const name = document.getElementById('username').value;
            const room = document.getElementById('room').value;
            const btn = document.querySelector('#login button');

            if(!name || !room) return alert('Veuillez remplir votre pseudo et le nom de la table.');
            
            btn.disabled = true;
            btn.innerText = "Connexion √† la table...";

            socket.emit('joinGame', { room, playerName: name });
            
            socket.once('error', (msg) => {
                alert(msg);
                btn.disabled = false;
                btn.innerText = "Entrer dans le Casino";
            });

            socket.on('updateLobby', (data) => {
                // Compatibilit√© : data peut √™tre l'objet {players, leaderId} ou juste le tableau (vieux code)
                const playersList = data.players || data; 
                const leaderId = data.leaderId;
                const mySocketId = socket.id;

                const div = document.getElementById('lobby-info');
                div.innerHTML = `<h3>Joueurs: ${playersList.join(', ')}</h3>`;
                
                const name = document.getElementById('username').value;
                if (playersList.includes(name)) {
                     document.getElementById('username').disabled = true;
                     document.getElementById('room').disabled = true;
                     document.querySelector('#login button').style.display = 'none';
                }

                if(playersList.length >= 2) {
                    // --- MODIFICATION : SEUL LE CHEF VOIT LE BOUTON ---
                    if (leaderId === mySocketId) {
                        if(!document.getElementById('btn-start-game')) {
                            div.innerHTML += `<button id="btn-start-game" onclick="socket.emit('startGame', '${document.getElementById('room').value}')">üëë LANCER LA PARTIE</button>`;
                        }
                    } else {
                        // Si je ne suis pas chef, j'affiche un message d'attente
                        if(!document.getElementById('msg-waiting')) {
                            div.innerHTML += `<div id="msg-waiting" style="margin-top:10px; opacity:0.8;">En attente du chef de salle...</div>`;
                        }
                        // On s'assure de supprimer le bouton s'il existait (cas o√π le chef change)
                        const btn = document.getElementById('btn-start-game');
                        if(btn) btn.remove();
                    }
                }
            });
        }

        // --- RENDER LOGIC ---
        socket.on('gameState', (state) => {
            if (gameState && gameState.state !== 'PLAYING' && state.state === 'PLAYING') {
                memoryLocked = false; 
            }
            gameState = state;
            myId = socket.id;
            
            if (gameState && gameState.state === 'ENDED' && state.state === 'PLAYING') {
                memoryLocked = false; 
            }
        
            if(state.state === 'LOBBY') return;
            
            showScreen('game-ui');
            renderTable();
            renderActions();
        });

        // R√©sultat du "Peek" (Dame)
        socket.on('peekResult', ({ card, index }) => {
            tempRevealedIndex = index;
            tempRevealedCardData = card;
            
            log("üëÅÔ∏è Vous observez votre carte (3s)...");
            renderTable();

            setTimeout(() => {
                tempRevealedIndex = null;
                tempRevealedCardData = null;
                renderTable(); 
                log("La carte est de nouveau cach√©e.");
            }, 3000);
        });

        // Rendu HTML d'une carte (Mise √† jour Design)
        function renderCardHTML(card, onClickStr = "", isFaceUp = false, highlight = false) {
            // Placeholder vide
            if(!card) return `<div class="card" style="opacity:0; pointer-events:none;"></div>`;
            
            const shouldBeHidden = card.back || (!isFaceUp && !card.back);
            let classes = "card";
            if(highlight) classes += " reveal-mode";

            if (shouldBeHidden) {
                // Dos de carte
                return `<div class="${classes} back" onclick="${onClickStr}"></div>`;
            } else {
                // Face visible
                const colorClass = (card.suit === '‚ô•' || card.suit === '‚ô¶') ? 'red' : 'black';
                
                // Structure HTML enrichie pour les coins (Corners)
                return `
                <div class="${classes} ${colorClass}" data-suit="${card.suit}" onclick="${onClickStr}">
                    <span class="corner-suit top-left">${card.value}<br>${card.suit}</span>
                    <div style="font-size:1.8em">${card.suit}</div>
                    <span class="corner-suit bottom-right">${card.value}<br>${card.suit}</span>
                </div>`;
            }
        }

        function renderTable() {
            const myIdx = gameState.players.findIndex(p => p.id === myId);
            const me = gameState.players[myIdx];

            // 1. D√©fausse (La carte du dessus)
            const topDiscard = gameState.discardPile[gameState.discardPile.length - 1];
            // On remplace le HTML du placeholder dans le DOM
            let discardHtml = renderCardHTML(topDiscard, "", true);
            // On injecte l'ID pour que le CSS fonctionne si besoin, mais on cible surtout le parent
            discardHtml = discardHtml.replace('class="card', 'id="discard-pile-card" class="card');             
            const discardEl = document.getElementById('discard-pile-card');
            if (discardEl) discardEl.outerHTML = discardHtml;

            // 2. Carte pioch√©e (Zone de transition)
            const drawnArea = document.getElementById('drawn-card-area');
            const isMyTurn = gameState.currentPlayerIndex === myIdx;
            
            if(gameState.drawnCard && isMyTurn) {
                drawnArea.style.display = 'flex';
                let drawnHtml = renderCardHTML(gameState.drawnCard, "", true);
                drawnHtml = drawnHtml.replace('class="card', 'id="drawn-card-display" class="card');
                const drawnEl = document.getElementById('drawn-card-display');
                if (drawnEl) drawnEl.outerHTML = drawnHtml;
            } else {
                drawnArea.style.display = 'none';
                if (!document.getElementById('drawn-card-display')) {
                    drawnArea.innerHTML = `<div id="drawn-card-display" class="card"></div>
                                           <div style="margin-top:10px;"><button class="btn-cancel" onclick="playAction('discard')">Jeter</button></div>`;
                }
            }

            // 3. MA MAIN
            const myHandDiv = document.getElementById('my-hand');
            const handHtml = me.hand.map((card, i) => {
                let action = `snapCard(${i})`; 
                let showCard = false; 
                let highlight = false;

                if (!memoryLocked && me.knownCards.includes(i) || gameState.state === 'ENDED') showCard = true;

                if (tempRevealedIndex === i && tempRevealedCardData) {
                    showCard = true;
                    card = tempRevealedCardData;
                    highlight = true;
                    action = "";
                }

                if (gameState.actionState && gameState.actionState.playerIdx === myIdx) {
                    if (gameState.actionState.type === 'PEEK') action = `resolvePower('PEEK', '${myId}', ${i})`;
                    if (gameState.actionState.type === 'SWAP') action = `storeSwapSource(${i})`;
                } else if (gameState.drawnCard && isMyTurn) {
                    action = `playAction('swap', ${i})`;
                }

                return renderCardHTML(card, action, showCard, highlight);
            }).join('');
            myHandDiv.innerHTML = handHtml;

            // Style tour actif
            const myArea = document.getElementById('my-player-area');
            if (isMyTurn) myArea.classList.add('active-turn'); else myArea.classList.remove('active-turn');
            document.getElementById('my-score').innerText = (gameState.state === 'ENDED') ? `Score Final: ${me.score}` : '';

// 4. ADVERSAIRES
            const oppContainer = document.getElementById('opponents-container');
            oppContainer.innerHTML = '';
            gameState.players.forEach((p, idx) => {
                if(p.id === myId) return;
                
                let oppHandHtml = p.hand.map((c, cIdx) => {
                    let action = "";
                    if (gameState.actionState && gameState.actionState.type === 'SWAP' && gameState.actionState.playerIdx === myIdx) {
                         action = `resolvePower('SWAP', '${p.id}', ${cIdx})`;
                    }
                    const isVisible = (gameState.state === 'ENDED');
                    
                    let h = renderCardHTML(c, action, isVisible);
                    
                    // --- CORRECTION ICI ---
                    // On injecte le style avant la classe pour ne pas casser le HTML
                    // Ancienne ligne bugg√©e : return h.replace('class="card', 'class="card" style="..."');
                    return h.replace('class="card', 'style="transform:scale(0.7); margin:-10px; box-shadow:none;" class="card'); 
                }).join('');

                const isTurn = (idx === gameState.currentPlayerIndex) ? 'active-turn' : '';
                oppContainer.innerHTML += `
                    <div class="player-area ${isTurn}">
                        <strong>${p.name} ${p.score !== undefined ? ' ‚Ä¢ '+p.score+' pts' : ''}</strong>
                        <div class="hand" style="transform: scale(0.8); grid-template-columns: repeat(2, 1fr); justify-content:center; gap:5px;">${oppHandHtml}</div>
                    </div>`;
            });
        }

        function renderActions() {
            const bar = document.getElementById('actions-bar');
            bar.innerHTML = ''; 
            const room = document.getElementById('room').value;

            // --- 1. FIN DE PARTIE : BOUTON REJOUER ---
            if (gameState.state === 'ENDED') {
                const isLeader = (gameState.leaderId === myId);
                
                let content = `
                    <div style="text-align:center; animation: fadein 1s;">
                        <div style="margin-bottom:10px; font-weight:bold; color:#ffeb3b; font-size:1.2em;">
                            üèÜ Partie Termin√©e !
                        </div>`;
                
                if (isLeader) {
                    content += `
                        <button class="btn-confirm" onclick="socket.emit('restartGame', '${room}')">
                            üëë REJOUER (M√™me salle)
                        </button>`;
                } else {
                    content += `
                        <div style="font-style:italic; opacity:0.8;">
                            En attente du chef de salle pour rejouer...
                        </div>`;
                }
                
                content += `</div>`;
                bar.innerHTML = content;
                return; // On s'arr√™te l√†
            }

            // --- DEBUT : MEMORISATION ---
            if (!memoryLocked && gameState.state === 'PLAYING') {
                bar.innerHTML = `
                    <div style="text-align:center">
                        <div style="margin-bottom:8px; color:#ddd;">M√©morisez 2 cartes...</div>
                        <button class="btn-confirm" onclick="lockMemory()">PR√äT √Ä JOUER</button>
                    </div>`;
                return; 
            }

            const myIdx = gameState.players.findIndex(p => p.id === myId);
            const isMyTurn = gameState.currentPlayerIndex === myIdx;
            const amILastPlayer = (gameState.lastPlayerId === myId);
            const canBuzz = amILastPlayer && !gameState.drawnCard;

            // --- BOUTON DUTCH ---
            if (!gameState.lastRound && (isMyTurn || canBuzz)) {
                let btnText = "üì¢ DUTCH";
                let btnStyle = ""; 
                let btnAction = `socket.emit('callDutch', '${room}')`;

                if (canBuzz && !isMyTurn) {
                    btnText = "‚ö° DUTCH ";
                    btnStyle = "background: #e67e22; border-color:white;";
                }

                bar.innerHTML += `<button class="btn-dutch" style="margin-right:20px; ${btnStyle}" onclick="${btnAction}">${btnText}</button>`;
            }

            // --- ACTIONS DE JEU ---
            if (isMyTurn) {
                if (gameState.actionState && gameState.actionState.playerIdx === myIdx) {
                    if (gameState.actionState.type === 'PEEK') {
                        bar.innerHTML += `<div style="color:var(--gold-shine); font-weight:bold; margin-right:10px;">üëÄ POUVOIR DAME: Cliquez sur une de vos cartes</div>`;
                    }
                    if (gameState.actionState.type === 'SWAP') {
                        bar.innerHTML += `<div style="color:var(--gold-shine); font-weight:bold; margin-right:10px;">üîÑ POUVOIR VALET: √âchangez vos cartes</div>`;
                    }
                    bar.innerHTML += `<button class="btn-cancel" onclick="socket.emit('skipPower', '${room}')">Passer le pouvoir</button>`;
                    return; 
                }

                if (!gameState.drawnCard) {
                   bar.innerHTML += `<span style="opacity:0.9; font-weight:bold; color:var(--gold-primary);">√Ä VOUS DE JOUER : PIOCHEZ</span>`;
                } else {
                   bar.innerHTML += `<span style="opacity:0.9; font-weight:bold;">Quelle carte √©changer ?</span>`;
                }
            }
            
            if (canBuzz && !isMyTurn) {
                 bar.innerHTML += `<span style="opacity:0.6; font-size:0.8em;">Tour adverse...</span>`;
            }
        }

        // --- ACTIONS JS INCHANGEES ---
        function lockMemory() {
            memoryLocked = true;
            renderTable();
            renderActions();
        }

        function drawCard(source) {
            if(!memoryLocked) return alert("Cliquez sur 'Pr√™t √† jouer' d'abord !");
            socket.emit('drawCard', { room: document.getElementById('room').value, source });
        }
        function playAction(action, cardIndex) {
            socket.emit('playAction', { room: document.getElementById('room').value, action, cardIndex });
        }
        function snapCard(index) {
            if(!memoryLocked) return;
            socket.emit('snap', { room: document.getElementById('room').value, cardIndex: index });
        }

        let swapSourceIndex = null;
        function storeSwapSource(index) {
            swapSourceIndex = index;
            log("üëá S√©lectionnez la carte adverse √† voler.");
            // Visuel local
            const cards = document.querySelectorAll('#my-hand .card');
            cards.forEach(c => c.style.border = 'none');
            if(cards[index]) cards[index].style.border = "3px solid var(--gold-primary)";
        }
        function resolvePower(type, targetId, targetCardIdx) {
            const room = document.getElementById('room').value;
            if (type === 'PEEK') {
                socket.emit('resolvePower', { room, type, targetPlayerId: targetId, targetCardIndex: targetCardIdx });
            } else if (type === 'SWAP') {
                if (swapSourceIndex === null) return alert("S√©lectionnez d'abord votre carte !");
                socket.emit('resolvePower', { room, type, targetPlayerId: targetId, targetCardIndex: targetCardIdx, myCardIndex: swapSourceIndex });
                swapSourceIndex = null;
            }
        }
        function leaveGame() {
            const room = document.getElementById('room').value;
            if(confirm("Veux-tu vraiment quitter la partie ?")) {
                socket.emit('leaveGame', room);
            }
        }

        // Confirmation du serveur que je suis parti
        socket.on('leftGameSuccess', () => {
            // On recharge la page pour revenir propre √† l'√©cran de login
            window.location.reload();
        });

        socket.on('gameMessage', (msg) => log(msg));
        socket.on('error', (msg) => alert(msg));
    </script>
</body>
</html>