<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dutch ‚Ä¢ Royal Casino</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. VARIABLES & THEME --- */
        :root {
            /* Palette Casino */
            --felt-bg: #2d5a45;
            --felt-dark: #1b382b;
            --gold-primary: #d4af37;
            --gold-shine: #f7ef8a;
            --card-white: #fdfdfd;
            --card-red: #d93838;
            --card-black: #222;
            --glass-panel: rgba(20, 30, 25, 0.75);
            --glass-border: rgba(212, 175, 55, 0.3);
            
            /* Dimensions */
            --card-w: 85px;
            --card-h: 120px;
            --radius-card: 8px;
            --radius-ui: 16px;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            color: #eee;
            background-color: var(--felt-bg);
            background-image: 
                radial-gradient(circle at center, transparent 0%, #000 120%),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- 2. ANIMATIONS --- */
        @keyframes deal {
            0% { transform: translateY(-50px) scale(0.8); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        /* --- 3. UI COMPONENTS (GLASSMORPHISM) --- */
        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-ui);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        button {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            border: none;
            border-radius: 50px;
            padding: 12px 28px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        
        button:active { transform: scale(0.96); }

        .btn-primary { background: linear-gradient(135deg, #d4af37, #aa8926); color: #1a1a1a; border: 1px solid #ffeebb; }
        .btn-primary:hover { box-shadow: 0 0 15px var(--gold-primary); filter: brightness(1.1); }
        .btn-dutch { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; font-size: 1.1em; border: 1px solid #ff7b7b; animation: pulse-gold 2s infinite; }
        .btn-confirm { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .btn-cancel { background: rgba(255,255,255,0.1); color: #ddd; border: 1px solid rgba(255,255,255,0.3); }

        /* --- 4. LOGIN SCREEN --- */
        #login {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2000;
            background: radial-gradient(circle, #2d5a45 0%, #000 100%);
        }
        #login.active { display: flex; }
        
        .login-card { padding: 50px 40px; width: 90%; max-width: 420px; text-align: center; border: 1px solid var(--gold-primary); }
        .login-card h1 { font-family: 'Cinzel', serif; font-size: 3.5em; color: var(--gold-primary); margin: 0 0 10px 0; }
        .subtitle { font-style: italic; opacity: 0.7; margin-bottom: 30px; font-family: 'Playfair Display', serif; }

        .login-input {
            width: 100%; padding: 16px; margin-bottom: 15px;
            border-radius: 8px; border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.3); color: var(--gold-primary);
            font-size: 1.1em; text-align: center; font-family: 'Cinzel', serif;
        }

        /* --- 5. GAME LAYOUT --- */
        #game-ui {
            display: none; height: 100vh; flex-direction: column;
            justify-content: space-between; padding: 10px; position: relative;
        }
        #game-ui.active { display: flex; }

        #opponents-container {
            display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;
            padding-top: 15px; min-height: 140px;
        }
        
        .player-area {
            position: relative; padding: 10px 15px; border-radius: 12px;
            background: rgba(0,0,0,0.3); text-align: center;
        }
        .player-area strong { display: block; font-size: 0.85em; margin-bottom: 6px; color: #aaa; font-family: 'Cinzel', serif; }
        
        .player-area.active-turn {
            background: rgba(212, 175, 55, 0.15); border: 1px solid var(--gold-primary);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
        }
        .player-area.active-turn strong { color: var(--gold-primary); }

        .table-center { flex: 1; display: flex; justify-content: center; align-items: center; gap: 40px; position: relative; }
        
        .pile-zone {
            position: relative; width: var(--card-w); height: var(--card-h);
            border-radius: var(--radius-card); border: 2px dashed rgba(255,255,255,0.1);
            display: flex; justify-content: center; align-items: center;
        }
        .pile-zone::after {
            content: attr(data-label); position: absolute; 
            color: rgba(255,255,255,0.15); font-weight: bold; font-size: 0.8em;
            pointer-events: none; z-index: 0;
        }

        .pile { position: absolute; top: 0; left: 0; cursor: pointer; transition: transform 0.2s; }
        .pile:hover { transform: translateY(-5px); }

        .actions-bar {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; align-items: center; justify-content: center;
            padding: 15px 30px; z-index: 500; min-width: 320px;
        }

        #my-player-area {
            align-self: center; margin-bottom: 170px; padding: 20px 40px;
            background: rgba(10, 20, 15, 0.6); backdrop-filter: blur(8px);
            border-radius: 20px; width: 95%; max-width: 650px;
            position: relative; z-index: 10; transition: all 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #my-player-area.active-turn {
            background: linear-gradient(to top, rgba(212, 175, 55, 0.15), rgba(0,0,0,0.4));
            border: 1px solid var(--gold-primary); box-shadow: 0 0 40px rgba(212, 175, 55, 0.15);
            transform: scale(1.02);
        }

        #my-player-area .card { transition: all 0.4s ease; filter: brightness(0.7) grayscale(0.2); }
        #my-player-area.active-turn .card { filter: brightness(1) grayscale(0); cursor: pointer; }
        #my-player-area.active-turn .card:hover, #my-player-area .card.reveal-mode { transform: translateY(-15px) scale(1.05); filter: brightness(1.1); }
        #my-player-area h3 { margin: 0; font-family: 'Cinzel', serif; color: rgba(255,255,255,0.4); }
        #my-player-area.active-turn h3 { color: var(--gold-primary); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        
        .hand { display: flex; justify-content: center; gap: 12px; margin: 0 auto; perspective: 1000px; }
        
        .card {
            width: var(--card-w); height: var(--card-h);
            border-radius: var(--radius-card); background-color: var(--card-white);
            position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 2px 4px 8px rgba(0,0,0,0.5); cursor: pointer;
            font-family: 'Playfair Display', serif; font-weight: bold; font-size: 1.8em; line-height: 1;
            transition: transform 0.2s, box-shadow 0.2s, top 0.2s;
            transform-style: preserve-3d;
        }
        
        .card:not(.back)::before {
            content: ""; position: absolute; inset: 0; opacity: 0.5; pointer-events: none; border-radius: var(--radius-card);
        }

        .card.red { color: var(--card-red); }
        .card.black { color: var(--card-black); }
        
        .card .corner-suit { position: absolute; font-size: 0.4em; font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; align-items: center; line-height: 0.9; }
        .card .top-left { top: 6px; left: 6px; }
        .card .bottom-right { bottom: 6px; right: 6px; transform: rotate(180deg); }

        .card.back {
            background-color: #3e5f8a;
            background-image: radial-gradient(white 15%, transparent 16%), radial-gradient(white 15%, transparent 16%);
            background-size: 20px 20px; background-position: 0 0, 10px 10px;
            border: 4px solid white; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .card.back::after { content: "‚ô¶"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2em; color: rgba(255,255,255,0.2); }
        .card.back div, .card.back span { display: none; }

        .card.reveal-mode { border: 2px solid var(--gold-primary); box-shadow: 0 0 25px var(--gold-primary); animation: pulse-gold 1s infinite; }

        #message-log {
            position: fixed; top: 20px; right: 20px; width: 320px;
            display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; z-index: 1000;
        }
        .log-entry {
            background: rgba(20, 20, 20, 0.85); color: #fff; padding: 10px 15px; margin-bottom: 8px; border-radius: 8px;
            font-size: 0.9em; border-left: 4px solid var(--gold-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            animation: deal 0.3s forwards; backdrop-filter: blur(4px); font-family: 'Roboto', sans-serif;
        }

        #rules-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .rules-content {
            background: #fff; color: #222; padding: 40px; border-radius: 12px;
            max-width: 550px; max-height: 85vh; overflow-y: auto; text-align: left;
            border: 4px solid var(--gold-primary); box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .rules-content h2 { margin-top: 0; color: #8b0000; font-family: 'Cinzel', serif; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* --- ANIMATIONS VOLANTES --- */
        .flying-card {
            position: fixed; z-index: 9999;
            width: var(--card-w); height: var(--card-h);
            border-radius: var(--radius-card); background-size: cover;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); pointer-events: none;
            transform-origin: center center;
        }

        .flip-in {
            animation: flip-in-anim 0.4s ease-out forwards;
        }

        @keyframes flip-in-anim {
            from { transform: rotateY(90deg); }
            to { transform: rotateY(0deg); }
        }
    </style>
</head>
<body>

    <div id="login" class="active">
        <div class="glass-panel login-card">
            <h1>‚ô¶ DUTCH ‚ô¶</h1>
            <div class="subtitle">La m√©moire est votre seule arme.</div>
            
            <input type="text" id="username" class="login-input" placeholder="Votre Pseudo" autocomplete="off">
            <input type="text" id="room" class="login-input" placeholder="Salle (ex: Table 1)" value="Table1">
            
            <button class="btn-primary" onclick="joinGame()" style="width:100%; margin-top:10px;">
                Entrer dans le Casino
            </button>
            
            <div id="lobby-info" style="margin-top:25px; min-height:20px; color:var(--gold-primary); font-family:'Cinzel', serif;"></div>
            
            <button onclick="document.getElementById('rules-modal').style.display='flex'" style="margin-top:20px; background:none; border:none; color:rgba(255,255,255,0.5); font-size:0.8em; text-decoration:underline; box-shadow:none;">
                Lire les r√®gles du jeu
            </button>
        </div>
    </div>

        <div id="game-ui">
        <button onclick="leaveGame()" style="position:absolute; top:10px; left:10px; background:#f44336; color:white; font-size:0.8em; padding:5px 10px; z-index:1000;">
            üö™ Quitter
        </button>

        <div id="opponents-container"></div>

        <div class="table-center">
            
            <div id="zone-pioche" class="pile-zone" data-label="PIOCHE">
                <div class="pile" onclick="drawCard('deck')">
                    <div class="card back"></div>
                </div>
            </div>
            
            <div id="zone-defausse" class="pile-zone" data-label="D√âFAUSSE">
                <div class="pile" onclick="drawCard('discard')">
                    <div id="discard-pile-card" class="card" style="opacity:0; pointer-events:none;"></div>
                </div>
            </div>

            <div id="drawn-card-area" style="display:none; flex-direction:column; align-items:center; margin-left:20px;">
                <div id="drawn-card-display" class="card" style="box-shadow: 0 0 25px var(--gold-primary);"></div>
                <div style="margin-top:15px;">
                    <button class="btn-cancel" onclick="playAction('discard')">üóëÔ∏è Jeter</button>
                </div>
            </div>
        </div>

        <div id="my-player-area" class="player-area">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-family:'Cinzel', serif; color:#fff;">MOI</h3>
                <span id="my-score" style="font-weight:bold; color:var(--gold-primary); font-size:1.2em;"></span>
            </div>
            <div id="my-hand" class="hand"></div>
        </div>

        <div class="actions-bar glass-panel" id="actions-bar"></div>
    </div>

    <div id="message-log"></div>

    <div id="rules-modal" onclick="this.style.display='none'">
        <div class="rules-content" onclick="event.stopPropagation()">
            <h2 style="text-align:center; color:var(--gold-primary); margin-bottom:20px;">üìú R√®gles Officielles</h2>
            
            <p><strong>Objectif :</strong> Terminer la manche avec le score le plus bas possible.</p>
            
            <h3 style="border-bottom:1px solid #ddd; padding-bottom:5px;">üÉè Valeur des Cartes</h3>
            <ul style="list-style:none; padding-left:0;">
                <li>ü§° <strong>Joker :</strong> -3 points (La meilleure !)</li>
                <li>üëë <strong>Roi Rouge (‚ô•/‚ô¶) :</strong> 0 point</li>
                <li>üÖ∞Ô∏è <strong>As :</strong> 1 point</li>
                <li>üî¢ <strong>2 √† 10 :</strong> Valeur du chiffre</li>
                <li>ü§¥ <strong>Figures (J, Q, K Noir) :</strong> 13 points</li>
            </ul>

            <h3 style="border-bottom:1px solid #ddd; padding-bottom:5px;">‚öîÔ∏è D√©roulement</h3>
            <p>Au d√©but, m√©morisez <strong>2</strong> de vos 4 cartes. √Ä chaque tour :</p>
            <ol>
                <li>Piochez une carte.</li>
                <li>√âchangez-la avec l'une de vos cartes (face cach√©e) OU jetez-la.</li>
                <li>Si la carte <strong>jet√©e</strong> est un Valet ou une Dame, un <strong>Pouvoir</strong> s'active.</li>
            </ol>

            <h3 style="border-bottom:1px solid #ddd; padding-bottom:5px;">‚ú® Pouvoirs & Actions</h3>
            <ul>
                <li>üë∏ <strong>Dame (Q) - Espion :</strong> Regardez secr√®tement l'une de vos cartes.</li>
                <li>ü§¥ <strong>Valet (J) - √âchange :</strong> √âchangez √† l'aveugle une de vos cartes contre celle d'un adversaire.</li>
                <li>‚ö° <strong>SNAP (√Ä la vol√©e) :</strong> M√™me si ce n'est pas votre tour, si la carte pos√©e sur la d√©fausse est <strong>identique</strong> √† une carte de votre main, soyez le plus rapide pour la jeter !</li>
                <li>üõ°Ô∏è <strong>Contre-Attaque :</strong> Si un joueur pose un Valet ou une Dame sur le v√¥tre (Snap), cela <strong>annule votre pouvoir</strong> !</li>
            </ul>

            <h3 style="border-bottom:1px solid #ddd; padding-bottom:5px;">üèÅ Fin de Partie</h3>
            <p>Si vous pensez avoir le score le plus bas, annoncez <strong>"DUTCH"</strong>. Cela d√©clenche le <strong>Dernier Tour</strong>.</p>
            <p><em>Note : Si vous n'avez plus de cartes en main, le Dutch est <strong>Automatique</strong>.</em></p>

            <div style="text-align:center; margin-top:30px;">
                <button class="btn-primary" onclick="document.getElementById('rules-modal').style.display='none'">J'ai compris</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null;
        let gameState = null;
        
        let memoryLocked = false; 
        let tempRevealedIndex = null; 
        let tempRevealedCardData = null; 

        function showScreen(id) {
            document.querySelectorAll('body > div[id]').forEach(d => d.classList.remove('active'));
            const el = document.getElementById(id);
            if(el) el.classList.add('active');
        }
        
        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry'; 
            div.innerHTML = msg; 
            document.getElementById('message-log').appendChild(div);
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transform = 'translateX(20px)';
                div.style.transition = 'all 0.5s';
                setTimeout(() => div.remove(), 500);
            }, 4000);
        }

        // --- CONNECTION ---
        function joinGame() {
            const name = document.getElementById('username').value;
            const room = document.getElementById('room').value;
            const btn = document.querySelector('#login button');

            if(!name || !room) return alert('Veuillez remplir votre pseudo et le nom de la table.');
            
            btn.disabled = true;
            btn.innerText = "Connexion √† la table...";

            socket.emit('joinGame', { room, playerName: name });
            
            socket.once('error', (msg) => {
                alert(msg);
                btn.disabled = false;
                btn.innerText = "Entrer dans le Casino";
            });

            socket.on('updateLobby', (data) => {
                const playersList = data.players || data; 
                const leaderId = data.leaderId;
                const mySocketId = socket.id;

                const div = document.getElementById('lobby-info');
                div.innerHTML = `<h3>Joueurs: ${playersList.join(', ')}</h3>`;
                
                const name = document.getElementById('username').value;
                if (playersList.includes(name)) {
                     document.getElementById('username').disabled = true;
                     document.getElementById('room').disabled = true;
                     document.querySelector('#login button').style.display = 'none';
                }

                if(playersList.length >= 2) {
                    if (leaderId === mySocketId) {
                        if(!document.getElementById('btn-start-game')) {
                            div.innerHTML += `<button id="btn-start-game" onclick="socket.emit('startGame', '${document.getElementById('room').value}')">üëë LANCER LA PARTIE</button>`;
                        }
                    } else {
                        if(!document.getElementById('msg-waiting')) {
                            div.innerHTML += `<div id="msg-waiting" style="margin-top:10px; opacity:0.8;">En attente du chef de salle...</div>`;
                        }
                        const btn = document.getElementById('btn-start-game');
                        if(btn) btn.remove();
                    }
                }
            });
        }

        // --- RENDER LOGIC ---
        socket.on('gameState', (state) => {
            if (gameState && gameState.state !== 'PLAYING' && state.state === 'PLAYING') {
                memoryLocked = false; 
            }
            gameState = state;
            myId = socket.id;
            
            if (gameState && gameState.state === 'ENDED' && state.state === 'PLAYING') {
                memoryLocked = false; 
            }
        
            if(state.state === 'LOBBY') return;
            
            showScreen('game-ui');
            renderTable();
            renderActions();
        });

        // R√©sultat du "Peek" (Dame) avec Animation Flip
        socket.on('peekResult', ({ card, index }) => {
            const handDiv = document.getElementById('my-hand');
            const cardEl = handDiv.children[index];

            // √âTAPE 1 : RETOURNER LA CARTE (Dos -> Tranche)
            if(cardEl) {
                cardEl.style.transition = "transform 0.25s ease-in";
                cardEl.style.transform = "rotateY(90deg)";
            }

            log("üëÅÔ∏è Vous observez votre carte (3s)...");

            // Attendre qu'elle soit invisible (sur la tranche)
            setTimeout(() => {
                // √âTAPE 2 : AFFICHER LA FACE
                tempRevealedIndex = index;
                tempRevealedCardData = card;
                renderTable(); 

                // Animation d'entr√©e (Tranche -> Face)
                const revealedEl = document.getElementById('my-hand').children[index];
                if(revealedEl) revealedEl.classList.add('flip-in');

                // √âTAPE 3 : ATTENDRE 3 SECONDES PUIS CACHER
                setTimeout(() => {
                    // Retourner √† nouveau (Face -> Tranche)
                    const elToHide = document.getElementById('my-hand').children[index];
                    if(elToHide) {
                        elToHide.style.transition = "transform 0.25s ease-in";
                        elToHide.style.transform = "rotateY(90deg)";
                        elToHide.classList.remove('flip-in');
                    }

                    // Une fois sur la tranche, remettre le dos
                    setTimeout(() => {
                        tempRevealedIndex = null;
                        tempRevealedCardData = null;
                        renderTable(); 

                        // Animation finale (Tranche -> Dos)
                        const hiddenEl = document.getElementById('my-hand').children[index];
                        if(hiddenEl) hiddenEl.classList.add('flip-in');
                        
                        log("La carte est de nouveau cach√©e.");
                    }, 250);

                }, 3000); // Dur√©e de la vision
            }, 250); // Dur√©e du premier flip
        });

        // R√âCEPTION IMM√âDIATE DE MA PIOCHE
        socket.on('privateCardDrawn', (card) => {
            const drawnArea = document.getElementById('drawn-card-area');
            drawnArea.style.display = 'flex';
            
            let drawnHtml = renderCardHTML(card, "", true);
            drawnHtml = drawnHtml.replace('class="card', 'id="drawn-card-display" class="card');
            
            const existingEl = document.getElementById('drawn-card-display');
            if (existingEl) existingEl.outerHTML = drawnHtml;
            else drawnArea.innerHTML = drawnHtml + `<div style="margin-top:10px;"><button class="btn-cancel" onclick="playAction('discard')">Jeter</button></div>`;

            gameState.drawnCard = card; 
        });

        function renderCardHTML(card, onClickStr = "", isFaceUp = false, highlight = false) {
            if(!card) return `<div class="card" style="opacity:0; pointer-events:none;"></div>`;
            
            const shouldBeHidden = card.back || (!isFaceUp && !card.back);
            let classes = "card";
            if(highlight) classes += " reveal-mode";

            if (shouldBeHidden) {
                return `<div class="${classes} back" onclick="${onClickStr}"></div>`;
            } else {
                const colorClass = (card.suit === '‚ô•' || card.suit === '‚ô¶') ? 'red' : 'black';
                return `
                <div class="${classes} ${colorClass}" data-suit="${card.suit}" onclick="${onClickStr}">
                    <span class="corner-suit top-left">${card.value}<br>${card.suit}</span>
                    <div style="font-size:1.8em">${card.suit}</div>
                    <span class="corner-suit bottom-right">${card.value}<br>${card.suit}</span>
                </div>`;
            }
        }

        function renderTable() {
            const myIdx = gameState.players.findIndex(p => p.id === myId);
            const me = gameState.players[myIdx];

            // 1. D√©fausse
            const topDiscard = gameState.discardPile[gameState.discardPile.length - 1];
            let discardHtml = renderCardHTML(topDiscard, "", true);
            discardHtml = discardHtml.replace('class="card', 'id="discard-pile-card" class="card');             
            const discardEl = document.getElementById('discard-pile-card');
            if (discardEl) discardEl.outerHTML = discardHtml;

            // 2. Carte pioch√©e
            const drawnArea = document.getElementById('drawn-card-area');
            const isMyTurn = gameState.currentPlayerIndex === myIdx;
            
            if(gameState.drawnCard && isMyTurn) {
                drawnArea.style.display = 'flex';
                let drawnHtml = renderCardHTML(gameState.drawnCard, "", true);
                drawnHtml = drawnHtml.replace('class="card', 'id="drawn-card-display" class="card');
                const drawnEl = document.getElementById('drawn-card-display');
                if (drawnEl) drawnEl.outerHTML = drawnHtml;
            } else {
                drawnArea.style.display = 'none';
                if (!document.getElementById('drawn-card-display')) {
                    drawnArea.innerHTML = `<div id="drawn-card-display" class="card"></div>
                                           <div style="margin-top:10px;"><button class="btn-cancel" onclick="playAction('discard')">Jeter</button></div>`;
                }
            }

            // 3. MA MAIN
            const myHandDiv = document.getElementById('my-hand');
            const handHtml = me.hand.map((card, i) => {
                let action = `snapCard(${i})`; 
                let showCard = false; 
                let highlight = false;

                if (!memoryLocked && me.knownCards.includes(i) || gameState.state === 'ENDED') showCard = true;

                if (tempRevealedIndex === i && tempRevealedCardData) {
                    showCard = true;
                    card = tempRevealedCardData;
                    highlight = true;
                    action = "";
                }

                if (gameState.actionState && gameState.actionState.playerIdx === myIdx) {
                    if (gameState.actionState.type === 'PEEK') action = `resolvePower('PEEK', '${myId}', ${i})`;
                    if (gameState.actionState.type === 'SWAP') action = `storeSwapSource(${i})`;
                } else if (gameState.drawnCard && isMyTurn) {
                    action = `playAction('swap', ${i})`;
                }

                return renderCardHTML(card, action, showCard, highlight);
            }).join('');
            myHandDiv.innerHTML = handHtml;

            const myArea = document.getElementById('my-player-area');
            if (isMyTurn) myArea.classList.add('active-turn'); else myArea.classList.remove('active-turn');
            document.getElementById('my-score').innerText = (gameState.state === 'ENDED') ? `Score Final: ${me.score}` : '';

            // 4. ADVERSAIRES
            const oppContainer = document.getElementById('opponents-container');
            oppContainer.innerHTML = '';
            gameState.players.forEach((p, idx) => {
                if(p.id === myId) return;
                
                let oppHandHtml = p.hand.map((c, cIdx) => {
                    let action = "";
                    if (gameState.actionState && gameState.actionState.type === 'SWAP' && gameState.actionState.playerIdx === myIdx) {
                         action = `resolvePower('SWAP', '${p.id}', ${cIdx})`;
                    }
                    const isVisible = (gameState.state === 'ENDED');
                    let h = renderCardHTML(c, action, isVisible);
                    return h.replace('class="card', 'style="transform:scale(0.7); margin:-10px; box-shadow:none;" class="card'); 
                }).join('');

                const isTurn = (idx === gameState.currentPlayerIndex) ? 'active-turn' : '';
                oppContainer.innerHTML += `
                    <div class="player-area ${isTurn}" data-id="${p.id}"> <strong>${p.name} ${p.score !== undefined ? ' ‚Ä¢ '+p.score+' pts' : ''}</strong>
                        <div class="hand" style="transform: scale(0.8); grid-template-columns: repeat(2, 1fr); justify-content:center; gap:5px;">${oppHandHtml}</div>
                    </div>`;
            });
        }

        function renderActions() {
            const bar = document.getElementById('actions-bar');
            bar.innerHTML = ''; 
            const room = document.getElementById('room').value;

            // --- 1. FIN DE PARTIE ---
            if (gameState.state === 'ENDED') {
                const isLeader = (gameState.leaderId === myId);
                let content = `
                    <div style="text-align:center; animation: fadein 1s;">
                        <div style="margin-bottom:10px; font-weight:bold; color:#ffeb3b; font-size:1.2em;">
                            üèÜ Partie Termin√©e !
                        </div>`;
                
                if (isLeader) {
                    content += `<button class="btn-confirm" onclick="socket.emit('restartGame', '${room}')">üëë REJOUER</button>`;
                } else {
                    content += `<div style="font-style:italic; opacity:0.8;">En attente du chef...</div>`;
                }
                content += `</div>`;
                bar.innerHTML = content;
                return;
            }

            // --- 2. DEBUT : MEMORISATION ---
            if (!memoryLocked && gameState.state === 'PLAYING') {
                bar.innerHTML = `
                    <div style="text-align:center">
                        <div style="margin-bottom:8px; color:#ddd;">M√©morisez 2 cartes...</div>
                        <button class="btn-confirm" onclick="lockMemory()">PR√äT √Ä JOUER</button>
                    </div>`;
                return; 
            }

            const myIdx = gameState.players.findIndex(p => p.id === myId);
            const isMyTurn = gameState.currentPlayerIndex === myIdx;

            // --- 3. GESTION DES POUVOIRS ---
            if (gameState.actionState && gameState.actionState.playerIdx === myIdx) {
                if (gameState.actionState.type === 'PEEK') {
                    bar.innerHTML += `<div style="color:var(--gold-shine); font-weight:bold; margin-right:10px;">üëÄ POUVOIR DAME: Cliquez sur une carte</div>`;
                }
                if (gameState.actionState.type === 'SWAP') {
                    bar.innerHTML += `<div style="color:var(--gold-shine); font-weight:bold; margin-right:10px;">üîÑ POUVOIR VALET: √âchangez deux cartes</div>`;
                }
                bar.innerHTML += `<button class="btn-cancel" onclick="socket.emit('skipPower', '${room}')">PASSER</button>`;
                return; 
            }

            // --- 4. BOUTON DUTCH ---
            const amILastPlayer = (gameState.lastPlayerId === myId);
            const canBuzz = amILastPlayer && !gameState.drawnCard && !gameState.actionState;

            if (!gameState.lastRound && (isMyTurn || canBuzz)) {
                let btnText = "üì¢ DUTCH";
                let btnStyle = ""; 
                let btnAction = `socket.emit('callDutch', '${room}')`;

                if (canBuzz && !isMyTurn) {
                    btnText = "‚ö° DUTCH";
                    btnStyle = "background: #e67e22; border-color:white;";
                }

                bar.innerHTML += `<button class="btn-dutch" style="margin-right:20px; ${btnStyle}" onclick="${btnAction}">${btnText}</button>`;
            }

            // --- 5. ACTIONS DE TOUR STANDARD ---
            if (isMyTurn) {
                if (!gameState.drawnCard) {
                   bar.innerHTML += `<span style="opacity:0.9; font-weight:bold; color:var(--gold-primary);">√Ä VOUS DE JOUER : PIOCHEZ</span>`;
                } else {
                   bar.innerHTML += `<span style="opacity:0.9; font-weight:bold;">Quelle carte √©changer ?</span>`;
                }
            } else if (canBuzz) {
                 bar.innerHTML += `<span style="opacity:0.6; font-size:0.8em;">Tour adverse...</span>`;
            }
        }

        // --- ACTIONS JS ---
        function lockMemory() {
            const handDiv = document.getElementById('my-hand');
            // Au d√©but, ce sont g√©n√©ralement les cartes 0 et 1 qui sont visibles
            const cardsToFlip = [0, 1]; 
            let animCount = 0;

            // 1. On tourne les cartes visibles √† 90¬∞ (tranche)
            cardsToFlip.forEach(i => {
                const el = handDiv.children[i];
                if(el && !el.classList.contains('back')) {
                    el.style.transition = "transform 0.3s ease-in";
                    el.style.transform = "rotateY(90deg)";
                    animCount++;
                }
            });

            // Si aucune carte √† retourner, on lance direct
            if (animCount === 0) {
                memoryLocked = true;
                renderTable();
                renderActions();
                return;
            }

            // 2. On attend qu'elles soient sur la tranche pour changer les donn√©es
            setTimeout(() => {
                memoryLocked = true;
                renderTable(); // Affiche les dos
                renderActions();
                
                // 3. On finit l'animation (de 90¬∞ √† 0¬∞) sur les nouvelles cartes (dos)
                cardsToFlip.forEach(i => {
                    const el = document.getElementById('my-hand').children[i];
                    if(el) el.classList.add('flip-in');
                });
            }, 300); // 300ms correspond √† la transition CSS
        }

        function drawCard(source) {
            if(!memoryLocked) return alert("Cliquez sur 'Pr√™t √† jouer' d'abord !");
            socket.emit('drawCard', { room: document.getElementById('room').value, source });
        }
        function playAction(action, cardIndex) {
            socket.emit('playAction', { room: document.getElementById('room').value, action, cardIndex });
        }
        function snapCard(index) {
            if(!memoryLocked) return;
            socket.emit('snap', { room: document.getElementById('room').value, cardIndex: index });
        }

        let swapSourceIndex = null;
        function storeSwapSource(index) {
            swapSourceIndex = index;
            log("üëá S√©lectionnez la carte adverse √† voler.");
            const cards = document.querySelectorAll('#my-hand .card');
            cards.forEach(c => c.style.border = 'none');
            if(cards[index]) cards[index].style.border = "3px solid var(--gold-primary)";
        }
        function resolvePower(type, targetId, targetCardIdx) {
            const room = document.getElementById('room').value;
            if (type === 'PEEK') {
                socket.emit('resolvePower', { room, type, targetPlayerId: targetId, targetCardIndex: targetCardIdx });
            } else if (type === 'SWAP') {
                if (swapSourceIndex === null) return alert("S√©lectionnez d'abord votre carte !");
                socket.emit('resolvePower', { room, type, targetPlayerId: targetId, targetCardIndex: targetCardIdx, myCardIndex: swapSourceIndex });
                swapSourceIndex = null;
            }
        }
        function leaveGame() {
            const room = document.getElementById('room').value;
            if(confirm("Veux-tu vraiment quitter la partie ?")) {
                socket.emit('leaveGame', room);
            }
        }
        socket.on('leftGameSuccess', () => {
            window.location.reload();
        });

        // --- GESTION DES ANIMATIONS VISUELLES ---
        
        socket.on('animate', (data) => performAnimation(data));

        function getCardElement(playerId, cardIndex) {
            if (playerId === myId) {
                const handDiv = document.getElementById('my-hand');
                return (handDiv && handDiv.children[cardIndex]) ? handDiv.children[cardIndex] : null;
            } else {
                const oppDivs = document.querySelectorAll('.player-area');
                for (let div of oppDivs) {
                    if (div.dataset.id === playerId) {
                        const hand = div.querySelector('.hand');
                        return (hand && hand.children[cardIndex]) ? hand.children[cardIndex] : null;
                    }
                }
            }
            return null;
        }

        // --- ANIMATION SIMPLE (1s) ---
        // --- ANIMATION SIMPLE (0.8s) ---
        function flyCardSimple(startElem, endElem, className = "back") {
            if (!startElem || !endElem) return;
            const startRect = startElem.getBoundingClientRect();
            const endRect = endElem.getBoundingClientRect();
            
            // Si √©l√©ment invisible, on annule
            if (startRect.width === 0 || endRect.width === 0) return;

            const flyer = document.createElement('div');
            flyer.className = `flying-card card ${className}`;
            
            // CORRECTION BUG VISUEL : On ne copie le contenu QUE si ce n'est pas un dos de carte
            if (!className.includes('back') && !startElem.classList.contains('back') && startElem.children.length > 0) {
                flyer.innerHTML = startElem.innerHTML;
                flyer.classList.remove('back');
                if (startElem.classList.contains('red')) flyer.classList.add('red');
                else flyer.classList.add('black');
            }

            document.body.appendChild(flyer);

            const flyerW = 85; const flyerH = 120;
            const startLeft = startRect.left + (startRect.width/2) - (flyerW/2);
            const startTop = startRect.top + (startRect.height/2) - (flyerH/2);
            const endLeft = endRect.left + (endRect.width/2) - (flyerW/2);
            const endTop = endRect.top + (endRect.height/2) - (flyerH/2);

            // D√©part
            flyer.style.left = `${startLeft}px`;
            flyer.style.top = `${startTop}px`;
            flyer.style.transition = 'all 0.8s ease-in-out'; // Vitesse 0.8s
            
            flyer.offsetHeight; // Force Reflow

            // Arriv√©e
            flyer.style.left = `${endLeft}px`;
            flyer.style.top = `${endTop}px`;
            flyer.style.transform = 'scale(1.1)'; 

            setTimeout(() => flyer.remove(), 800); // Nettoyage 0.8s
        }

        // --- ANIMATION VALET COMPLEXE (3s) ---
        function animateJackSwap(elemA, elemB) {
            if (!elemA || !elemB) return;

            const rectA = elemA.getBoundingClientRect();
            const rectB = elemB.getBoundingClientRect();
            const w = 85, h = 120; 

            const createFlyer = (rect, className = "back") => {
                const f = document.createElement('div');
                f.className = 'flying-card card ' + className;
                f.style.left = `${rect.left + (rect.width/2) - (w/2)}px`;
                f.style.top = `${rect.top + (rect.height/2) - (h/2)}px`;
                f.style.transition = 'all 1.5s ease-in-out'; 
                document.body.appendChild(f);
                return f;
            };

            const flyerA = createFlyer(rectA);
            const flyerB = createFlyer(rectB);

            // PHASE 1 : GROSSIR (0.75s)
            setTimeout(() => {
                flyerA.style.transition = 'transform 0.75s ease';
                flyerB.style.transition = 'transform 0.75s ease';
                
                flyerA.style.transform = 'scale(1.3) rotate(-5deg)';
                flyerB.style.transform = 'scale(1.3) rotate(5deg)';
                flyerA.style.zIndex = 10000; 
                flyerB.style.zIndex = 10000;
            }, 20);

            // PHASE 2 : GLISSER (1.5s)
            setTimeout(() => {
                flyerA.style.transition = 'all 1.5s ease-in-out';
                flyerB.style.transition = 'all 1.5s ease-in-out';

                flyerA.style.left = `${rectB.left + (rectB.width/2) - (w/2)}px`;
                flyerA.style.top = `${rectB.top + (rectB.height/2) - (h/2)}px`;
                
                flyerB.style.left = `${rectA.left + (rectA.width/2) - (w/2)}px`;
                flyerB.style.top = `${rectA.top + (rectA.height/2) - (h/2)}px`;

            }, 750); 

            // PHASE 3 : RETRECIR (0.75s)
            setTimeout(() => {
                flyerA.style.transition = 'transform 0.75s ease';
                flyerB.style.transition = 'transform 0.75s ease';
                
                flyerA.style.transform = 'scale(1) rotate(0deg)';
                flyerB.style.transform = 'scale(1) rotate(0deg)';
            }, 2250); 

            // FIN
            setTimeout(() => {
                flyerA.remove();
                flyerB.remove();
            }, 3000);
        }

        function performAnimation(data) {
            const deck = document.getElementById('zone-pioche');
            const discardZone = document.getElementById('zone-defausse');
            const drawnDisplay = document.getElementById('drawn-card-display') || document.getElementById('drawn-card-area');

            if (data.type === 'DRAW') {
                let target;
                if (data.playerId === myId) {
                    target = document.getElementById('drawn-card-display') || document.getElementById('drawn-card-area');
                } else {
                    target = Array.from(document.querySelectorAll('.player-area'))
                        .find(d => d.dataset.id === data.playerId);
                }
                flyCardSimple(deck, target);
            }

            else if (data.type === 'DISCARD_DRAWN') {
                let start;
                if (data.playerId === myId) {
                     start = drawnDisplay;
                } else {
                     start = Array.from(document.querySelectorAll('.player-area'))
                        .find(d => d.dataset.id === data.playerId);
                }
                flyCardSimple(start, discardZone);
            }

            else if (data.type === 'SWAP_SELF') {
                const handCard = getCardElement(data.playerId, data.cardIndex);
                flyCardSimple(handCard, discardZone);
            }

            else if (data.type === 'SNAP') {
                const handCard = getCardElement(data.playerId, data.cardIndex);
                flyCardSimple(handCard, discardZone);
            }

            else if (data.type === 'SWAP_PLAYERS') {
                const cardA = getCardElement(data.fromId, data.fromIndex);
                const cardB = getCardElement(data.toId, data.toIndex);
                animateJackSwap(cardA, cardB);
                log("üîÄ Le Valet frappe ! √âchange en cours...");
            }
        }

        socket.on('gameMessage', (msg) => log(msg));
        socket.on('error', (msg) => alert(msg));
    </script>
</body>
</html>